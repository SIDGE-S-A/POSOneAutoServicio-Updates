name: Deploy Updates to Netlify

on:
  repository_dispatch:
    types: [deploy-from-main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ğŸ‘ˆ Asegura que trae todos los archivos, incluyendo netlify.toml

      - name: ğŸ§© Descargar assets del release
        uses: robinraju/release-downloader@v1.10
        with:
          repository: SIDGE-S-A/POSOneAutoServicio-Updates
          latest: true
          out-file-path: ./public
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      # ğŸ‘‡ Copiamos el netlify.toml desde la raÃ­z hacia ./public/
      - name: ğŸª„ Copiar netlify.toml al directorio pÃºblico
        run: |
          if [ -f netlify.toml ]; then
            cp netlify.toml ./public/netlify.toml
            echo "âœ… netlify.toml copiado a ./public/"
          else
            echo "âš ï¸ netlify.toml no encontrado en la raÃ­z del repo"
            ls -la
            exit 1
          fi

      - name: ğŸš€ Deploy to Netlify
        run: |
          npm install -g netlify-cli
          netlify deploy --dir=public --prod \
            --site ${{ secrets.NETLIFY_SITE_ID }} \
            --auth ${{ secrets.NETLIFY_AUTH_TOKEN }} \
            --message "Deploy automÃ¡tico con netlify.toml desde raÃ­z"
